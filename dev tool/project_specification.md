# 향기 디스펜서 구독 서비스 시스템 - 개발 지침서

## 📋 1. 프로젝트 개요

### 1.1 시스템 목적
향기 디스펜서 렌탈 구독 서비스를 위한 통합 관리 플랫폼 구축
- 구독 고객, 밴더, 영업사원, 본사, 루시드(디자인 업체) 간 협업 시스템
- 기기(시리얼) 추적부터 콘텐츠 수정, 정산까지 전 프로세스 관리

### 1.2 기술 스택
- **Backend**: PHP (현재 프로젝트 기반)
- **Database**: MySQL 8.0+
- **Frontend**: HTML5, CSS3, JavaScript (Vanilla + jQuery)
- **Architecture**: MVC 기반, AJAX 활용

### 1.3 핵심 비즈니스 룰
1. **구독 모델**: 월 29,700원, 2개월 주기 정기배송 (향 6회/연)
2. **계층 구조**: 본사 → 밴더 → 영업사원 → 구독고객
3. **시리얼 추적**: 기기 입고 → 설치 → 사용 이력 → 회수 → 폐기
4. **콘텐츠 커스터마이징**: 고객 요청 → 루시드 작업 → 승인 → 출고
5. **정산**: 밴더/영업사원/루시드 자동 정산 (커미션, 인센티브, 배분)

---

## 🏗️ 2. 시스템 아키텍처

### 2.1 회원 체계 및 권한

```
┌──────────────────────────────────────────────────────────┐
│                    최고관리자 (SUPER_ADMIN)                │
│                  - 전체 시스템 접근 및 설정                 │
└───────────────────────┬──────────────────────────────────┘
                        │
        ┌───────────────┴───────────────┐
        │        본사 (HQ_ADMIN)         │
        │    - 밴더/정책/정산 총괄       │
        └───────────┬───────────────────┘
                    │
        ┌───────────┴───────────────┐
        │                           │
    ┌───▼────┐              ┌──────▼──────┐
    │ 밴더    │              │  영업사원    │
    │(VENDOR)│              │(SALES_REP)  │
    │소속고객 │              │ 담당고객     │
    │관리     │              │ 관리         │
    └───┬────┘              └──────┬──────┘
        │                          │
        └──────────┬───────────────┘
                   │
           ┌───────▼────────┐
           │  구독 고객      │
           │  (CUSTOMER)    │
           │  서비스 이용    │
           └────────────────┘

        ┌─────────────────────┐
        │   루시드 (LUCID)     │
        │   콘텐츠 디자인      │
        └─────────────────────┘
```

### 2.2 데이터 흐름

**구독 프로세스**
```
신규 가입 → 구독 생성 → 기기 배정 → 정기 배송 (2개월 주기)
    ↓           ↓            ↓              ↓
고객정보    구독항목     시리얼매핑     작업지시서/출고
```

**콘텐츠 수정 프로세스**
```
고객 요청 → 장바구니 → 결제 → 루시드 배정 → 시안 제작
   ↓                                          ↓
주문생성                                   서버 업로드
   ↓                                          ↓
루시드 알림 ←─────────────────────────────── 고객 검토
                                             ↓
                                    재수정 OR 확정
                                             ↓
                                    본사 작업지시서
                                             ↓
                                         프린팅 → 배송
```

**정산 프로세스**
```
매출 발생 → 청구서 생성 → 결제 완료 → 정산 계산
    ↓           ↓             ↓           ↓
상품판매    고객별 집계   트랜잭션    밴더/영업/루시드
                                    배분 및 지급
```

---

## 📦 3. 핵심 도메인 모델

### 3.1 상품 분류 체계

#### 카테고리 4단계 구조
**설계 원칙**
- 모든 상품(콘텐츠, 향, 기기, 부자재, 악세사리)에 적용
- 계층적 구조로 확장성 확보
- `parent_id`로 상위 레벨 참조
- 각 레벨별로 `display_order` 정렬 가능

**카테고리 레벨 정의**
- **Level 1**: 최상위 분류 (예: 향 계열, 콘텐츠 유형)
- **Level 2**: 중분류 (예: Woody, Floral, 계절별)
- **Level 3**: 소분류 (예: Pine, Lavender, 봄 시즌)
- **Level 4**: 세부 분류 (예: 강도별, 용량별)

**카테고리 예시**
```
향 카트리지
├─ Woody (Level 2)
│  ├─ Pine (Level 3)
│  │  ├─ 약함 (Level 4)
│  │  ├─ 보통 (Level 4)
│  │  └─ 강함 (Level 4)
│  └─ Cedar (Level 3)
│     ├─ 20ml (Level 4)
│     └─ 50ml (Level 4)
└─ Floral (Level 2)
   └─ Lavender (Level 3)
      ├─ 프리미엄 (Level 4)
      └─ 스탠다드 (Level 4)

콘텐츠
├─ 계절별 (Level 2)
│  ├─ 봄 (Level 3)
│  │  ├─ 벚꽃 (Level 4)
│  │  └─ 새싹 (Level 4)
│  └─ 여름 (Level 3)
├─ 테마별 (Level 2)
│  ├─ 휴양 (Level 3)
│  └─ 비즈니스 (Level 3)
```

#### 태그 시스템
**설계 원칙**
- 카테고리 외 추가 분류/검색을 위한 유연한 메타데이터
- 다대다(M:N) 관계로 하나의 상품에 여러 태그 적용 가능
- 태그는 동적으로 생성/관리

**태그 적용 대상**
- Contents (콘텐츠)
- Scents (향 카트리지)
- Devices (디스펜서)
- Parts (부자재)
- Accessories (악세사리)

**태그 예시**
```sql
-- 태그 마스터
Tags: [신상품, 베스트셀러, 한정판, 고급, 가성비, 친환경, 알러지프리, 강추천]

-- 태그 매핑 예시
Content ID: 1001 → Tags: [신상품, 베스트셀러, 계절한정]
Scent ID: 5001 → Tags: [친환경, 알러지프리, 강추천]
Device ID: 3001 → Tags: [고급, 신상품]
```

**구현 구조**
```
┌─────────┐         ┌──────────┐         ┌──────────┐
│  Tags   │         │ Tag_Map  │         │ Products │
├─────────┤         ├──────────┤         ├──────────┤
│ tag_id  │◄────────│ tag_id   │         │ (각 상품) │
│ name    │         │ entity_type ──────►│ ID       │
│ slug    │         │ entity_id│         │ ...      │
└─────────┘         └──────────┘         └──────────┘
```

### 3.2 상품별 특성

#### 1) 디스펜서 (Devices)
**특징**
- 물리적 기기로 시리얼 번호(Serial Number) 단위 관리
- 생명주기: 입고 → 재고 → 설치 → 사용 → 회수 → 폐기
- IoT 연결 시 온라인/오프라인 상태 추적

**관리 항목**
- 제품 정보: 모델명, 제조사, 사양
- 시리얼 정보: 고유 번호, QR 코드, 제조일
- 상태 관리: AVAILABLE, ASSIGNED, MAINTENANCE, RETIRED
- 설치 정보: 고객 현장(Site), 설치 위치, 설치일
- 사용 이력: 콘텐츠 교체, 향 교체, 유지보수 로그

**비즈니스 룰**
- 기기는 구독 시작 시 고객에게 배정
- 구독 해지 시 회수 처리
- 무상/유상 수리 구분 (자연 고장 vs 과실)

#### 2) 콘텐츠 (Contents)
**특징**
- 디스펜서에 부착되는 인쇄물 (계절, 테마, 홍보 등)
- 기본 6종 무료 제공, 커스터마이징 시 유료

**관리 항목**
- 기본 정보: 제목, 설명, 이미지 URL, 템플릿
- 카테고리: 4단계 분류 (예: 계절 > 봄 > 벚꽃 > 파스텔톤)
- 태그: 다중 태그 (신상품, 베스트, 한정판 등)
- 사이즈: A4, A5 등
- 소유자: 공용(본사) / 고객 전용

**커스터마이징 등급**
- **프린팅** (5,000원): 문구만 수정
- **베이직** (15,000원): 이미지 교체 + 문구 수정
- **디럭스** (30,000원): 부분 재디자인
- **프리미엄** (50,000원): 완전 신규 디자인

#### 3) 향 카트리지 (Scents)
**특징**
- 디스펜서에 장착되는 향 오일
- 구독 시 연 6회 기본 제공
- 조기 소진 또는 취향에 따라 추가 구매 가능

**관리 항목**
- 기본 정보: 향 이름, 계열, 설명, 이미지
- 카테고리: 4단계 분류 (예: Woody > Pine > 강도 > 강함)
- 태그: 친환경, 알러지프리, 인기 등
- 용량: 20ml, 50ml, 100ml
- 가격: 단품 가격, 세트 가격

**비즈니스 룰**
- 기본 구독에는 2개월마다 자동 배송
- 추가 구매 시 장바구니/결제 프로세스

#### 4) 부자재 (Parts)
**특징**
- 디스펜서 유지보수용 교체 부품
- 무상/유상 구분

**관리 항목**
- 부품명, 호환 모델, 가격, 재고

**비즈니스 룰**
- 자연 고장: 무상
- 고객 과실: 유상

#### 5) 악세사리 (Accessories)
**특징**
- 디스펜서 관련 추가 상품 (거치대, 케이스 등)

**관리 항목**
- 악세사리명, 가격, 재고

---

## 🔄 4. 핵심 비즈니스 프로세스

### 4.1 구독 생애주기

#### Phase 1: 신규 가입
```
1. 고객 회원가입 (또는 밴더/영업사원이 대리 가입)
2. 구독 상품 선택 (기본: 디스펜서 + 향 + 콘텐츠)
3. 결제 정보 등록 (CMS 계좌 또는 카드)
4. 설치 현장(Site) 정보 입력
5. 첫 구독 주기(Cycle) 생성
```

**데이터 생성**
- `customers` 테이블: 고객 기본 정보
- `customer_sites` 테이블: 설치 현장
- `subscriptions` 테이블: 구독 마스터
- `subscription_items` 테이블: 구독 항목 (디스펜서, 향, 콘텐츠)
- `subscription_cycles` 테이블: 첫 주기

#### Phase 2: 정기 배송 (2개월 주기)
```
1. 구독 주기(Cycle) 자동 생성 (D-7)
2. 작업지시서(Work Order) 생성
   - 향 카트리지 출고
   - 콘텐츠 출고 (기본 또는 커스텀)
3. 출고(Shipment) 처리
4. 배송 추적
5. 청구서(Invoice) 발행
6. 결제 처리 (자동 결제)
```

**비즈니스 룰**
- 주기 시작 7일 전 자동 생성
- 고객이 주기별로 향/콘텐츠 선택 가능
- 결제 실패 시 재시도 (3회) → 구독 일시정지

#### Phase 3: 해지/갱신
```
[해지]
1. 고객 해지 요청
2. 관리자 승인
3. 기기 회수 스케줄링
4. 최종 정산
5. 구독 상태: CANCELLED

[갱신]
1. 계약 만료 D-30 알림
2. 고객 갱신 의사 확인
3. 새 계약 생성 (또는 자동 연장)
```

### 4.2 콘텐츠 수정 워크플로우

```
┌─────────────────────────────────────────────────────────────┐
│  고객: 콘텐츠 수정 요청                                       │
│  - 라이브러리에서 기본 템플릿 선택                            │
│  - 수정 등급 선택 (프린팅/베이직/디럭스/프리미엄)             │
│  - 수정 내용 입력 (텍스트, 이미지 업로드, 요청사항)          │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│  시스템: 장바구니 → 결제                                      │
│  - 수정 등급별 금액 계산                                      │
│  - 결제 처리 (카드/계좌)                                      │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│  시스템: 루시드 배정                                          │
│  - ContentRequest 레코드 생성                                │
│  - 루시드 자동 배정 (workload 기반) 또는 수동 배정           │
│  - 루시드에게 알림 발송                                       │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│  루시드: 시안 제작                                            │
│  - 요청 내용 검토                                             │
│  - 디자인 작업                                                │
│  - 시안 파일 서버 업로드 (URL 저장)                          │
│  - 상태 변경: PENDING → IN_PROGRESS → REVIEW                │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│  고객: 시안 검토                                              │
│  - 시안 미리보기                                              │
│  - 피드백 입력                                                │
│  - 선택: 재수정 요청 OR 확정                                  │
└───────┬───────────────────────────────┬─────────────────────┘
        │                               │
   재수정 요청                        확정
        │                               │
        ▼                               ▼
┌─────────────────┐         ┌─────────────────────────────────┐
│ 루시드 재작업    │         │  시스템: 본사 작업지시서 생성    │
│ (최대 2회)      │         │  - WorkOrder 생성               │
│ 상태: REVISION  │         │  - 프린팅 업체 전달             │
└────────┬────────┘         │  - 상태: APPROVED              │
         │                  └─────────────┬───────────────────┘
         │                                │
         └─────► (다시 검토 프로세스)      ▼
                                 ┌───────────────────────┐
                                 │  프린팅 → 배송         │
                                 │  - Shipment 생성      │
                                 │  - 배송 추적          │
                                 │  - 완료: COMPLETED    │
                                 └───────────────────────┘
```

**상태 변화**
- `PENDING`: 루시드 배정 대기
- `ASSIGNED`: 루시드 배정 완료
- `IN_PROGRESS`: 작업 중
- `REVIEW`: 고객 검토 대기
- `REVISION`: 재수정 요청
- `APPROVED`: 고객 확정
- `COMPLETED`: 프린팅 및 배송 완료
- `CANCELLED`: 취소

### 4.3 정산 프로세스

#### 밴더 정산
**계산 공식**
```
커미션 = 유료 매출 × 40%
인센티브 = 유료 매출 × 5%
총 지급액 = 커미션 + 인센티브
```

**정산 주기**: 익월 15일
**대상**: 소속 고객의 모든 유료 거래

#### 영업사원 정산
**판매 인센티브**
```
신규 계약 시: 90,000원 (분할 지급)
- 1~6회차: 각 15,000원 (구독료 결제 시마다)
```

**리뉴얼 인센티브**
```
기본: 30,000원
연속 리뉴얼: 40,000원
```

**정산 주기**: 익월 15일

#### 루시드 정산
**배분율**
```
콘텐츠 수정 금액 × 50%
```

**조건**: 고객 수정 요청 건만 (기본 콘텐츠 등록은 제외)
**정산 주기**: 익월 15일

---

## 💾 5. 데이터베이스 설계 원칙

### 5.1 네이밍 규칙
- **테이블명**: 복수형, snake_case (예: `customers`, `content_requests`)
- **컬럼명**: snake_case (예: `created_at`, `vendor_id`)
- **FK 컬럼**: `{참조테이블}_id` (예: `customer_id`, `vendor_id`)
- **Boolean**: `is_`, `has_` 접두사 (예: `is_active`, `has_penalty`)
- **날짜/시간**: `_at`, `_date` 접미사 (예: `created_at`, `due_date`)

### 5.2 공통 컬럼
모든 테이블에 기본 포함
```sql
created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
created_by INT NULL,  -- 생성자 user_id
updated_by INT NULL   -- 수정자 user_id
```

### 5.3 인덱스 전략
- **Primary Key**: 모든 테이블에 AUTO_INCREMENT INT
- **Foreign Key**: 참조 무결성 및 인덱스 자동 생성
- **복합 인덱스**: 자주 함께 조회되는 컬럼 (예: `vendor_id, status`)
- **Unique 제약**: 중복 방지 (예: `email`, `serial_number`)

### 5.4 Soft Delete
주요 마스터 데이터는 물리 삭제 대신 Soft Delete
```sql
deleted_at DATETIME NULL,
INDEX idx_deleted (deleted_at)
```

### 5.5 코멘트 규칙
- **테이블 코멘트**: 한글로 명확한 설명
- **컬럼 코멘트**: 필수, 값의 범위/형식 포함
- **ENUM 타입**: 가능한 값 모두 나열

---

## 🔐 6. 보안 및 권한

### 6.1 인증/인가
- 세션 기반 인증
- 역할(Role) 기반 권한 제어
- 페이지별 권한 검증 (`canAccessXXX()`)

### 6.2 데이터 보안
- SQL Injection 방지: Prepared Statements 필수
- XSS 방지: `htmlspecialchars()` 적용
- CSRF 방지: 토큰 검증
- 비밀번호: `password_hash()` (bcrypt)

### 6.3 데이터 접근 제한
- 밴더: 소속 고객만
- 영업사원: 담당 고객만
- 고객: 본인 데이터만
- 루시드: 배정된 요청만

---

## 📊 7. 성능 최적화

### 7.1 인덱스 최적화
```sql
-- 자주 조회되는 FK
CREATE INDEX idx_customer_vendor ON customers(vendor_id);
CREATE INDEX idx_subscription_customer ON subscriptions(customer_id);

-- 상태별 필터링
CREATE INDEX idx_subscription_status ON subscriptions(status);
CREATE INDEX idx_content_request_status ON content_requests(status);

-- 복합 인덱스 (담당자 배정)
CREATE INDEX idx_assignments_active ON account_assignments(sales_user_id, is_active);

-- 날짜 범위 검색
CREATE INDEX idx_invoices_date ON invoices(invoice_date);
CREATE INDEX idx_cycles_start ON subscription_cycles(cycle_start_date);
```

### 7.2 쿼리 최적화
- `SELECT *` 지양, 필요한 컬럼만
- JOIN 대신 서브쿼리 최소화
- WHERE 절에 함수 사용 지양
- 페이징 시 OFFSET 대신 Keyset Pagination

### 7.3 캐싱
- 자주 조회되는 정책 데이터 (커미션율 등)
- 카테고리 트리
- 태그 목록

---

## 🧪 8. 테스트 전략

### 8.1 더미 데이터
각 주요 테이블에 20건 이상의 현실적인 더미 데이터 필수
- 회원: 각 타입별 5명 이상
- 상품: 각 분류별 10개 이상
- 구독: 다양한 상태 포함
- 트랜잭션: 성공/실패 케이스 포함

### 8.2 테스트 시나리오
- **구독 플로우**: 가입 → 정기 배송 → 해지
- **콘텐츠 수정**: 요청 → 루시드 작업 → 재수정 → 확정
- **정산**: 매출 발생 → 청구 → 결제 → 배분 계산
- **권한**: 각 역할별 접근 제어 검증

---

## 📱 9. 포털별 핵심 기능

### 9.1 HQ (본사) 포털
**핵심 책임**: 전체 시스템 관리 및 정책 수립

**주요 기능**
- 대시보드: KPI, 실적 현황, 알림
- 고객 관리: 전체 고객 조회/수정
- 밴더 관리: 계약, 정산, 실적
- 영업사원 관리: 배정, 실적, 인센티브
- 상품 관리: 기기, 콘텐츠, 향, 부자재
- 구독 관리: 전체 구독 현황
- 작업지시서: 생성, 진행 상황
- 출고/배송: 재고 관리, 출고 지시
- 정산: 밴더/영업/루시드 정산 처리
- 정책 설정: 커미션율, 가격, 인센티브
- 콘텐츠 요청 모니터링: 루시드 작업 현황
- 티켓 시스템: 고객 문의 처리

**메뉴 ID**: H01 ~ H09

### 9.2 VENDOR (밴더) 포털
**핵심 책임**: 소속 고객 관리 및 영업 활동

**주요 기능**
- 대시보드: 소속 고객 실적, 정산 요약
- 고객 관리: 소속 고객만 조회/관리
- 영업사원 관리: 소속 영업사원 관리
- 구독 관리: 소속 고객 구독 현황
- 작업지시서: 읽기 전용 조회
- 청구/결제: 소속 고객 청구 내역
- 정산 내역: 커미션, 인센티브 조회
- 상품 구매: 밴더 할인가로 구매
- 재고 관리: 보유 재고 현황
- 티켓 관리: 소속 고객 문의
- 카탈로그: 신규 상품 정보
- 알림센터

**메뉴 ID**: V01 ~ V11

### 9.3 CUSTOMER (고객) 포털
**핵심 책임**: 구독 서비스 이용 및 관리

**주요 기능**
- 대시보드: 구독 현황, 다음 배송일, 최근 주문
- 기기 관리: 설치 현장별 기기 현황
- 콘텐츠 라이브러리: 선택/수정 요청
- 향 라이브러리: 선택/추가 구매
- 배송 정보: 배송 추적, 히스토리
- 결제 관리: 카드/계좌 변경, 결제 내역
- 구독 관리: 일시정지, 해지
- 장바구니: 추가 구매
- 문의: 티켓 생성

**메뉴 ID**: C01 ~ C08

### 9.4 LUCID (루시드) 포털
**핵심 책임**: 콘텐츠 디자인 및 제작

**주요 기능**
- 대시보드: 배정된 요청, 마감 임박 건
- 신규 콘텐츠 등록: 기본 템플릿 업로드
- 수정 요청 처리: 시안 제작 및 업로드
- 콘텐츠 라이브러리: 본인 제작 콘텐츠
- 태그 관리: 콘텐츠 태그 추가/수정
- 정산 내역: 배분액 조회

**메뉴 ID**: L01 ~ L06

### 9.5 SALES (영업사원) 포털
**핵심 책임**: 고객 영업 및 관리

**주요 기능**
- 대시보드: 담당 고객 현황, 실적
- 고객 관리: 담당 고객만 조회
- 리뉴얼 관리: 계약 만료 알림, 리뉴얼 처리
- 영업활동 리포트: 방문, 상담 기록
- 인센티브 조회: 판매/리뉴얼 인센티브
- KPI 현황: 목표 대비 달성률
- 교육 자료실
- 공지사항
- 계약 관리: 본인 계약 정보

**메뉴 ID**: S01 ~ S09

---

## 🚀 10. 개발 체크리스트

### Phase 1: 기반 구조
- [ ] 데이터베이스 스키마 생성
- [ ] 더미 데이터 삽입 (각 테이블 20건+)
- [ ] 공통 함수 라이브러리 (`inc/common.php`)
- [ ] 인증/권한 시스템
- [ ] 표준 응답 포맷 (`Finish()`)

### Phase 2: 코어 기능
- [ ] 회원 관리 (가입, 로그인, 권한)
- [ ] 상품 관리 (CRUD, 카테고리, 태그)
- [ ] 구독 생성 및 주기 관리
- [ ] 작업지시서 및 출고 시스템
- [ ] 청구/결제 시스템

### Phase 3: 고급 기능
- [ ] 콘텐츠 수정 워크플로우
- [ ] 정산 자동 계산 및 처리
- [ ] 티켓 시스템
- [ ] 대시보드 및 리포트
- [ ] 알림 시스템

### Phase 4: 최적화 및 테스트
- [ ] 인덱스 최적화
- [ ] 쿼리 성능 튜닝
- [ ] 통합 테스트
- [ ] 보안 검증
- [ ] UI/UX 개선

---

## 📝 코딩 가이드라인

### PHP 코딩 스타일
```php
// ✅ GOOD
function getCustomerSubscriptions($customerId, $status = null) {
    global $mysqli;
    
    $sql = "SELECT * FROM subscriptions WHERE customer_id = ?";
    $params = [$customerId];
    $types = "i";
    
    if ($status !== null) {
        $sql .= " AND status = ?";
        $params[] = $status;
        $types .= "s";
    }
    
    $stmt = $mysqli->prepare($sql);
    $stmt->bind_param($types, ...$params);
    $stmt->execute();
    $result = $stmt->get_result();
    
    return $result->fetch_all(MYSQLI_ASSOC);
}

// ❌ BAD - SQL Injection 취약
function getCustomerSubscriptions($customerId) {
    global $mysqli;
    $sql = "SELECT * FROM subscriptions WHERE customer_id = $customerId";
    return $mysqli->query($sql)->fetch_all(MYSQLI_ASSOC);
}
```

### AJAX 요청 패턴
```javascript
// ✅ GOOD
function updateSubscription(subscriptionId, data) {
    $.ajax({
        url: window.location.pathname,
        type: 'POST',
        data: {
            action: 'update_subscription',
            subscription_id: subscriptionId,
            ...data
        },
        success: function(response) {
            if (response.success) {
                showNotification('success', response.message);
                reloadTable();
            } else {
                showNotification('error', response.message);
            }
        },
        error: function() {
            showNotification('error', '서버 오류가 발생했습니다.');
        }
    });
}
```

### 트랜잭션 사용
```php
// ✅ GOOD - 트랜잭션으로 묶기
$mysqli->begin_transaction();
try {
    // 청구서 생성
    $invoiceId = createInvoice($data);
    
    // 청구서 항목 추가
    foreach ($items as $item) {
        addInvoiceItem($invoiceId, $item);
    }
    
    // 정산 레코드 생성
    createSettlement($invoiceId);
    
    $mysqli->commit();
    Finish(true, "청구서가 생성되었습니다.", ['invoice_id' => $invoiceId]);
} catch (Exception $e) {
    $mysqli->rollback();
    Finish(false, "청구서 생성 실패: " . $e->getMessage());
}
```

---

## 🎯 다음 단계

1. **DB 스키마 생성** (이 문서 기반)
2. **더미 데이터 삽입 스크립트** 작성
3. **공통 라이브러리** 구현 (`inc/common.php`)
4. **인증/권한 시스템** 구현
5. **포털별 핵심 페이지** 개발 시작

---

**문서 버전**: 1.0
**최종 수정일**: 2025-11-10
**작성자**: All2Green Development Team
